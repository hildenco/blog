# Monitoring ASP.NET Containers
When something goes wrong in a system, the concerned stakeholders will want to know what has happened, why it has happened and any hint or clue for fixing it, and how to prevent the same problem from occurring again in the future. This is one of the primary uses of monitoring. However, monitoring spans well beyond this primary usage.

In .NET monoliths, there are multiple monitoring solutions available to choose from. Also, the monitoring target is always centralized, and monitoring is certainly easy to set up and configure. If something breaks down, we know what to look for and where to look for it since only a finite number of components participate in a system, and they have a fairly long life span.

However, microservices are distributed systems and, by nature, more complex than monoliths. So resource utilization and health and performance monitoring are quite essential in a microservice production environment. We can use this diagnostic piece of information to detect and correct issues and also to spot potential problems and prevent them from occurring. Monitoring microservices presents different challenges. In this chapter, we will primarily discuss the following topics:

    The need for monitoring
    Monitoring and logging challenges in microservices
    Available tools and strategies for microservices in the .NET monitoring space 
    Use of Azure diagnostics and application insight
    A brief overview of the ELK stack and Splunk

# Instrumentation and telemetry

A monitoring solution is dependent upon instrumentation and telemetry. So it is natural that when we speak about monitoring microservices, we also discuss instrumentation and telemetry data. Logs are nothing but an instrumentation mechanism


# Instrumentation

Now let's see what is instrumentation. Instrumentation is one of the ways through which you can add diagnostic features to applications. It can be formally defined like this:
Most applications will include diagnostic features that generate custom monitoring and debugging information, especially when an error occurs. This is referred to as instrumentation and is usually implemented by adding event and error handling code to the application. -MSDN

Under normal conditions, data from some informational events may not be required, thus reducing the cost of storage and the transactions required to collect it. However, when there is an issue with the application, you have to update the application configuration so that the diagnostic and instrumentation systems can collect informational event data as well as error and warning messages to assist in isolating and fixing faults. It may be necessary to run the application in this extended reporting mode for some time if the problem appears only intermittently.


# Telemetry
Telemetry, in its most basic form, is the process of gathering information generated by instrumentation and logging systems. Typically, it is performed using asynchronous mechanisms that support massive scaling and wide distribution of application services. It can be defined as follows:
The process of gathering remote information that is collected by instrumentation is usually referred to as telemetry. -MSDN

In large and complex applications, information is usually captured in a data pipeline and stored in a form that makes it easier to analyze and capable of presenting information at different levels of granularity. This information is used to discover trends, gain insight into usage and performance, and detect and isolate faults.

Azure has no built-in system that directly provides a telemetry and reporting system of this type. However, a combination of the features exposed by all the Azure services, Azure diagnostics, and application insight allows you to create telemetry mechanisms that span the range of simple monitoring mechanisms to comprehensive dashboards. The complexity of the telemetry mechanism you require usually depends on the size of the application. T

# Centralized logging

There is a difference between centralized logging and centralized monitoring. In centralized logging, we log all the details about the events that occur in our system--they may be errors or warnings or just for informational purposes. Whereas in centralized monitoring, we monitor critical parameters, that is, specific information.

With logs, we can understand what has actually happened in the system or a specific transaction. We will have all the details about the specific transaction, such as why it started, who triggered it, what kind of data or resources it recorded, and so on. In a complex distributed system, such as microservices, this is really the key piece of information with which we can solve the entire puzzle of information flow or errors. We also need to treat timeouts, exceptions, and errors as events that we need to log.

The information we record regarding a specific event should also be structured, and this structure should be consistent across our system. So, for example, our structured log entry might contain level-based information to state whether the log entry is for information or an error or whether it's debug information or statistics that's been recorded as a log entry event. The structured log entry must also have a date and time so we know when the event happened

# Monitoring in Azure

Definitely, there is not even one right-off-the-shelf solution or offering found as of now on Azure or for that matter any cloud provider to the monitoring challenges presented by microservices. Interestingly enough, there are not too many open source tools available that can work with .NET-based microservices.

We are utilizing Microsoft Azure Cloud and cloud services for building our microservices, so it is useful to look for the monitoring capability it comes along with. If you are looking to manage around a couple of hundred microservices, you can utilize a custom monitoring solution (mostly interweaving Powershell scripts) based on a Microsoft Azure-based solution.

The following logging and monitoring solutions are very useful to have:
    * Microsoft Azure Diagnostics: This helps in collecting and analyzing resources through resource and activity logs.
    * Application Insights: This helps in collecting all of the telemetry data about our microservices and analyzing them. This is a framework-based approach for monitoring.
    * Log Analytics: Log Analytics analyzes and displays data and provides scalable querying capability

# Introduction of Application Insights

Application Insights is an application performance management (APM) offering from Microsoft. It is a useful service offering to monitor the performance of .NET-based microservices. It is useful to understand the internal operational behavior of individual microservices. Instead of just focusing on detecting and diagnosing issues, it will tune the service performance and understand the performance characteristic of your microservice. It is one of the examples of a framework-based approach to monitoring. What it means is that during the development of a microservice, we will add the Application Insights package to the Visual Studio solution of our microservice. This is how Application Insights instruments your microservice for telemetry data. This might not always be an ideal approach for every microservice; however, it comes in handy if you have not given any good, thorough thought about monitoring your microservices. 

These are some services that AppInsights provide:
    * HTTP request rates, response times, and success rates
    * Dependency (HTTP & SQL) call rates, response times, and success rates
    * Exception traces from both server and client
    * Diagnostic log traces
    * Page view counts, user and session counts, browser load times, and exceptions
    * AJAX call rates, response times, and success rates
    * Server performance counters
    * Custom client and server telemetry
    * Segmentation by client location, browser version, OS version, server instance, custom dimensions, and more
    * Availability tests

Along with the preceding types, there are associated diagnostic and analytics tools available for alerting and monitoring with various different customizable metrics. With its own query language and customizable dashboards, Application Insights forms a good monitoring solution for .NET microservices.
A brief overview of the ELK stack

As we saw, one of the fundamental tools for monitoring is logging. For microservices, there will be a volume of logs generated that are astounding and sometimes not even comprehended by humans. The ELK stack (also referred to as the elastic stack) is the most popular log management platform. It is also a good candidate for microservice monitoring because of its ability to aggregate, analyze, visualize, and monitor. The ELK stack is a toolchain that includes three distinct tools, namely Elasticsearch, Logstash, and Kibana. Let's visit them one by one to understand their role in the ELK stack.